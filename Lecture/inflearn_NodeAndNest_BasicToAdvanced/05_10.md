<!-- TOC -->

- [Multerì™€ ë¯¸ë””ì–´ íŒŒì¼ ì„œë¹„ìŠ¤ mp3, mp4, img ë“±](#multer%EC%99%80-%EB%AF%B8%EB%94%94%EC%96%B4-%ED%8C%8C%EC%9D%BC-%EC%84%9C%EB%B9%84%EC%8A%A4-mp3-mp4-img-%EB%93%B1)
  - [multipart/form-data](#multipartform-data)
  - [íŒŒì¼ ì—…ë¡œë“œ](#%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C)
  - [ë””ë¹„ë¡œ url ì €ì¥](#%EB%94%94%EB%B9%84%EB%A1%9C-url-%EC%A0%80%EC%9E%A5)

<!-- /TOC -->

# Multerì™€ ë¯¸ë””ì–´ íŒŒì¼ ì„œë¹„ìŠ¤ (mp3, mp4, img ë“±)

## multipart/form-data 
HTTP í¬ìŠ¤íŠ¸ ìš”ì²­ì„ í†µí•´ì„œ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ë³´ë‚¼ë•Œ ì‚¬ìš©í•˜ëŠ” í˜•ì‹

MulterModule ì¶”ê°€,  
destì˜ ê²½ë¡œëŠ” nestí”„ë¡œì íŠ¸ ìì²´ì— í´ë”ë¥¼ ìƒì„±í•´ì„œ íŒŒì¼ì„ ì €ì¥  
-> 05_CatsCommunity/upload/1c37542b79c38add77b81d4561e3aa76
``` typescript
// 05_CatsCommunity/src/cats/cats.module.ts

@Module({
  imports: [
    MulterModule.register({ dest: './upload' }),
```

## íŒŒì¼ ì—…ë¡œë“œ
``` typescript
// 05_CatsCommunity/src/common/utils/multer.options.ts

import * as multer from 'multer';
import * as path from 'path';
import * as fs from 'fs';
import { MulterOptions } from '@nestjs/platform-express/multer/interfaces/multer-options.interface';

const createFolder = (folder: string) => {
  try {
    console.log('ğŸ’¾ Create a root uploads folder...');
    fs.mkdirSync(path.join(__dirname, '..', `uploads`));
  } catch (error) {
    console.log('The folder already exists...');
  }
  try {
    console.log(`ğŸ’¾ Create a ${folder} uploads folder...`);
    fs.mkdirSync(path.join(__dirname, '..', `uploads/${folder}`));
  } catch (error) {
    console.log(`The ${folder} folder already exists...`);
  }
};

const storage = (folder: string): multer.StorageEngine => {
  createFolder(folder);
  return multer.diskStorage({
    destination(req, file, cb) {
      //* ì–´ë””ì— ì €ì¥í•  ì§€
      const folderName = path.join(__dirname, '..', `uploads/${folder}`);
      cb(null, folderName);
    },
    filename(req, file, cb) {
      //* ì–´ë–¤ ì´ë¦„ìœ¼ë¡œ ì˜¬ë¦´ ì§€
      const ext = path.extname(file.originalname);

      const fileName = `${path.basename(
        file.originalname,
        ext,
      )}${Date.now()}${ext}`;

      cb(null, fileName);
    },
  });
};

export const multerOptions = (folder: string) => {
  const result: MulterOptions = {
    storage: storage(folder),
  };
  return result;
};
```

``` typescript
// 05_CatsCommunity/src/cats/cats.controller.ts

  @ApiOperation({ summary: 'ê³ ì–‘ì´ ì´ë¯¸ì§€ ì—…ë¡œë“œ' })
  @UseInterceptors(FilesInterceptor('image', 10, multerOptions('cats')))
  @Post('upload')
  uploadCatImg(@UploadedFiles() files: Array<Express.Multer.File>) {
    console.log(files);
    // return 'uploadImg';
    return { image: `http://localhost:8000/media/cats/${files[0].filename}` };
  }
```

ìŠ¤íƒœí‹± íŒŒì¼ ì œê³µ  
í™•ì‹¤í•˜ê²Œ express ì•±ì´ ë˜ë˜ë¡ NestExpressApplication ì œë„¤ë¦­ ì§€ì •  
  
``` typescript
// 05_CatsCommunity/src/main.ts

async function bootstrap() {
  const app = await NestFactory.create<NestExpressApplication>(AppModule);
  app.useGlobalPipes(new ValidationPipe({ transform: true }));
  app.useGlobalFilters(new HttpExceptionFilter());

  app.use(
    ['/docs', '/docs-json'],
    expressBasicAuth({
      challenge: true,
      users: {
        [process.env.SWAGGER_USER]: process.env.SWAGGER_PASSWORD,
      },
    }),
  );

  app.useStaticAssets(path.join(__dirname, './common', 'uploads'), {
    prefix: '/media',
  });
```

ì €ì¥ëœ íŒŒì¼ ê²½ë¡œ  
05_CatsCommunity/dist/common/uploads/cats/11653929400250.jpeg


## ë””ë¹„ë¡œ url ì €ì¥
``` typescript
// 05_CatsCommunity/src/cats/cats.controller.ts

  @ApiOperation({ summary: 'ê³ ì–‘ì´ ì´ë¯¸ì§€ ì—…ë¡œë“œ' })
  @UseInterceptors(FilesInterceptor('image', 10, multerOptions('cats')))
  @UseGuards(JwtAuthGuard)
  @Post('upload')
  uploadCatImg(
    @UploadedFiles() files: Array<Express.Multer.File>,
    @CurrentUser() cat: Cat,
  ) {
    return this.catsService.uploadImg(cat, files);
  }
```

``` typescript
// 05_CatsCommunity/src/cats/cats.service.ts

  async uploadImg(cat: Cat, files: Express.Multer.File[]) {
    const fileName = `cats/${files[0].filename}`;
    const newCat = await this.catsRepository.findByIdAndUpdateImg(
      cat.id,
      fileName,
    );

    return newCat;
  }
```

``` typescript
// 05_CatsCommunity/src/cats/cats.repository.ts

  async findByIdAndUpdateImg(catId: string, imgUrl: string): Promise<Cat> {
    const cat = await this.catModel.findById(catId);
    cat.imgUrl = `http://localhost:8000/media/${imgUrl}`;
    const newCat = await cat.save();
    console.log(newCat);
    return newCat;
  }
```

ìŠ¤í‚¤ë§ˆì— ê¸°ë³¸ url ì§€ì •
``` typescript
// 05_CatsCommunity/src/cats/cats.schema.ts

  @Prop({
    default: 'http://localhost:8000/media/cats/11653979260912.jpeg',
  })
  @IsString()
  imgUrl: string;

  readonly readOnlyData: { id: string; email: string; name: string; imgUrl: string };
}

export const CatSchema = SchemaFactory.createForClass(Cat);

CatSchema.virtual('readOnlyData').get(function (this: Cat) {
  return {
    id: this.id,
    email: this.email,
    name: this.name,
    imgUrl: this.imgUrl,
  };
});
```